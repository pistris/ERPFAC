<!-- Container -->
<div class="progress progress-bar-xs mb-10">
    <div class="progress-bar bg-success w-25" name="progressbar" id="progressbar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
</div>
<div class="alert alert-danger" id="divMensajeError" role="alert" style="text-align: center; display: none;">
    <label id="lblMensajeError" style="color: #8b0c12;"></label>
</div>
<div class="alert alert-success" id="divMensajeExito" role="alert" style="text-align: center; display: none;">
    <label id="lblMensajeExito" style="color: #05592b;"></label>
</div>

<div class="container">

    <!-- Row -->
    <div class="row">
        <div class="col-xl-12">
            <section class="hk-sec-wrapper">
                <h5 class="hk-sec-title">Empresas</h5>
                <div class="row">
                    <div class="col-sm">
                        <div class="table-wrap">
                            <table id="datable_1" class="table table-hover w-100 display">
                                <thead>
                                    <tr>
                                        <th>id</th>
                                        <th>Nombre</th>
                                        <th>RFC</th>
                                        <th>Estado</th>
                                        <th colspan="2"></th>
                                    </tr>
                                </thead>
                                <tbody id="datos">

                                </tbody>
                            </table>
                            <div>
                                <button type="button" id="btnAgregar" class="btn btn-success">Nueva Empresa</button>
                                <!--<button type="button" id="btnFinalizar" class="btn btn-success">Finalizar</button>-->
                            </div>

                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>








    <div class="modal fade" id="ModalEditar" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="intEmpresa">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Nombre*</label>
                            <input type="text" name="txtNombre" id="txtNombre" class="form-control" placeholder="" required>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label>Razón Social*</label>
                            <input type="text" name="txtRazon" id="txtRazon" class="form-control" placeholder="" required>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label>RFC*</label>
                            <input type="text" name="txtRFC" id="txtRFC" class="form-control" placeholder="" required>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Estado*</label>
                            <select class="form-control selEstado" name="selEstado" id="selEstado" required></select>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label>Ciudad*</label>
                            <select class="form-control selCiudad" name="selCiudad" id="selCiudad" disabled required></select>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label>Dirección*</label>
                            <input type="text" name="txtDireccion" id="txtDireccion" class="form-control" placeholder="" required>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label>Num. Exterior*</label>
                            <input type="text" name="txtNumExterior" id="txtNumExterior" class="form-control" placeholder="" required>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Num. Interior</label>
                            <input type="text" name="txtNumInterior" id="txtNumInterior" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-3">
                            <label>C.P*</label>
                            <input type="text" name="txtCP" id="txtCP" class="form-control" placeholder="" required>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Régimen Fiscal*</label>
                            <select class="form-control" name="selRegimen" id="selRegimen" required></select>
                            <div class="invalid-feedback">
                                Campo Obligatorio
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Logo</label>
                            <div class="row">
                                <div class="col-sm">
                                    <div class="form-group mb-0">
                                        <div class="fileinput fileinput-new input-group" data-provides="fileinput" id="iconFile" name="iconFile">
                                            <div class="form-control text-truncate" data-trigger="fileinput">
                                                <i class="glyphicon glyphicon-file fileinput-exists"></i>
                                                <span class="fileinput-filename" id="lblLogo" name="lblLogo"></span>
                                                <input type="hidden" id="hlblLogo">
                                            </div>
                                            <span class="input-group-append">
                                                <span class=" btn btn-primary btn-file"><span class="fileinput-new">Seleccionar</span><span class="fileinput-exists">Cambiar</span>
                                            <input type="file" accept="image/png, image/jpeg" name="imgLogo" id="imgLogo">
                                            </span>
                                            <a href="#" class="btn btn-secondary fileinput-exists" data-dismiss="fileinput">Borrar</a>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Email</label>
                            <input type="text" name="txtEmail" id="txtEmail" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Teléfono</label>
                            <input type="text" name="txtTelefono" id="txtTelefono" class="form-control" placeholder="">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Activo</label>
                            <div class="custom-control custom-checkbox checkbox-teal">
                                <input type="checkbox" class="custom-control-input" name="chActivo" id="chActivo" checked>
                                <label class="custom-control-label" for="chActivo"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" id="btnConfirmarAgregar" class="btn btn-success">Agregar</button>
                    <button type="button" id="btnModificar" class="btn btn-success">Modificar</button>

                    <button type="button" data-dismiss="modal" class="btn btn-success">Cancelar</button>
                </div>

            </div>
        </div>
    </div>

    <div class="alert alert-warning alert-wth-icon alert-dismissible fade" id="alertBorrar" style="position:absolute; right: 0px; top: 50px;" role="alert">
        <span class="alert-icon-wrap"><i class="zmdi zmdi-alert-circle-o"></i></span>
        <h4 class="alert-heading">Este movimiento es permante.</h4>
        ¿Desea borrar la empresa?
        <br>
        <input type="hidden" id="intEmpresaBorrar">
        <button class="btn btn-secondary mt-20 mr-5" class="close" onclick="cerrarAlert()">Cancelar</button>
        <button class="btn btn-primary mt-20" id="btnConfirmarBorrado">Aceptar</button>
        <button type="button" class="close" onclick="cerrarAlert()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <!-- /Row -->
</div>
<script>
    function cerrarAlert() {
        $("#alertBorrar").removeClass('show')
    }
    document.addEventListener("DOMContentLoaded", function() {

        var empresa;
        MostrarEmpresas();
        CargarEstados();
        CargarRegimenFiscal()

        /* INICIA CARGAR DATOS */
        function MostrarEmpresas() {
            $.ajax({
                type: 'GET',
                url: 'Modulos/Empresas/ProEmpresas.php?accion=listar',
                success: function(respons) {
                    $('#progressbar').removeClass('w-25');
                    $('#progressbar').addClass('w-100');
                    let filas = '';
                    for (let empresa of respons) {
                        //<button class="btn btn-icon btn-icon-circle btn-secondary btn-icon-style-3"><span class="btn-icon-wrap"><i class="fa fa-pencil"></i></span></button>
                        filas += `
                                <tr>
                                    <td>` + empresa.intEmpresa + `</td>
                                    <td>` + empresa.varNombreComercial + `</td>
                                    <td>` + empresa.varRFC + `</td>
                                    <td>` + empresa.estado + `</td>
                                    <td>
                                        <button class="btn btn-icon btn-icon-circle btn-secondary btn-icon-style-3 botonEditar" data-codigo="` + empresa.intEmpresa + `">
                                            <span class="btn-icon-wrap"><i class="fa fa-pencil"></i></span>
                                        </button>
                                    
                                        <button class="btn btn-icon btn-icon-circle btn-info btn-icon-style-3 botonBorrar" data-codigo="` + empresa.intEmpresa + `">
                                            <span class="btn-icon-wrap"><i class="icon-trash"></i></span>
                                        </button>
                                    </td>
                                </tr>
                            `
                    }
                    setTimeout(function() {
                        $('#progressbar').hide();
                    }, 3000);
                    $('#datos').html(filas);
                    //Boton que muestra el diÃ¡logo de modificar y borrar
                    $('.botonEditar').click(function() {
                        //LimpiarFormulario()

                        $('#intEmpresa').val($(this).get(0).dataset.codigo);
                        $('#progressbar').removeClass('w-100');
                        $('#progressbar').addClass('w-25');
                        $('#progressbar').show();

                        RecolectarDatosFormulario('recuperar')
                        $('#btnConfirmarAgregar').hide();
                        $('#btnModificar').show();
                        $('#btnBorrar').show();

                        $("#ModalEditar").modal();
                    });
                    $('.botonBorrar').click(function() {
                        $('#intEmpresaBorrar').val($(this).get(0).dataset.codigo);
                        $("#alertBorrar").addClass('show')
                    })

                },
                error: function() {
                    $('#progressbar').removeClass('w-25');
                    $('#progressbar').addClass('w-100');
                    $("#ModalEditar").modal('hide');
                    $('#divMensajeError').show()
                    $('#lblMensajeError').html('No se pueden recuperar los datos')
                    setTimeout(function() {
                        $('#progressbar').hide();
                        $('#divMensajeError').hide()
                    }, 3000);
                }
            });
        }

        function CargarEstados() {
            $.ajax({
                type: 'GET',
                url: 'Modulos/Empresas/ProEmpresas.php?accion=estados',
                success: function(respons) {
                    let filas = '';
                    let x = 0;
                    for (let estado of respons) {
                        if (x == 0) {
                            filas += '<option value="">Seleccionar</option>';
                            x++;
                        }
                        filas += '<option value="' + estado.intEstado + '">' + estado.varEstado + '</option>';
                    }
                    $('#selEstado').html(filas);
                },
                error: function() {
                    $("#ModalEditar").modal('hide');
                    $('#divMensajeError').show()
                    $('#lblMensajeError').html('No se pueden recuperar los datos')
                    setTimeout(function() {
                        $('#progressbar').hide();
                        $('#divMensajeError').hide()
                    }, 3000);
                }
            });
        }

        function CargarRegimenFiscal() {
            $.ajax({
                type: 'GET',
                url: 'Modulos/Empresas/ProEmpresas.php?accion=regimenfiscal',
                success: function(respons) {
                    let filas = '';
                    let x = 0;
                    for (let regimen of respons) {
                        if (x == 0) {
                            filas += '<option value="">Seleccionar</option>';
                            x++;
                        }
                        filas += '<option value="' + regimen.intRegimenFiscal + '">' + regimen.varDescripcion + '</option>';
                    }
                    $('#selRegimen').html(filas);
                },
                error: function() {
                    $("#ModalEditar").modal('hide');
                    $('#divMensajeError').show()
                    $('#lblMensajeError').html('No se pueden recuperar los datos')
                    setTimeout(function() {
                        $('#progressbar').hide();
                        $('#divMensajeError').hide()
                    }, 3000);
                }
            });
        }

        function CargarCiudades(id, ciudadEstado) {
            $.ajax({
                type: 'POST',
                url: 'Modulos/Empresas/ProEmpresas.php?accion=ciudad',
                data: {
                    intEstado: id
                },
                success: function(respons) {
                    let filas = '';
                    let x = 0;
                    let selected = ''
                    for (let ciudad of respons) {
                        if (ciudadEstado == ciudad.intCiudad) {
                            selected = 'selected';
                        } else {
                            selected = ''
                        }
                        if (x == 0) {
                            filas += '<option value="">Seleccionar</option>';
                            x++;
                        }
                        filas += '<option value="' + ciudad.intCiudad + '" ' + selected + '>' + ciudad.VarNombre + '</option>';
                    }
                    $('#selCiudad').html(filas);
                    $("#selCiudad").prop("disabled", false);

                },
                error: function() {
                    $("#ModalEditar").modal('hide');
                    $('#divMensajeError').show()
                    $('#lblMensajeError').html('No se pueden recuperar los datos')
                    setTimeout(function() {
                        $('#progressbar').hide();
                        $('#divMensajeError').hide()
                    }, 3000);
                }
            });
        }
        /* FIN CARGAR DATOS */

        /* INICIA BOTONES*/
        $('#btnAgregar').click(function() {
            LimpiarFormulario();
            $('#btnConfirmarAgregar').show();
            $('#btnModificar').hide();
            $('#btnBorrar').hide();
            $("#ModalEditar").modal();
        });

        $('#btnConfirmarAgregar').click(function() {
            if (validaForm()) {
                $('#progressbar').removeClass('w-100');
                $('#progressbar').addClass('w-25');
                $('#progressbar').show();
                RecolectarDatosFormulario('agregar')
            }
        });

        $('#btnModificar').click(function() {
            if (validaForm()) {
                $('#progressbar').removeClass('w-100');
                $('#progressbar').addClass('w-25');
                $('#progressbar').show();
                RecolectarDatosFormulario('modificar')
            }
        });

        $('#btnBorrar').click(function() {
            $("#ModalEditar").modal('hide');
            $("#ModalConfirmarBorrar").modal();
        });

        $('#btnConfirmarBorrado').click(function() {
            empresa = {
                intEmpresa: $("#intEmpresaBorrar").val()
            }

            if (!validarBorrar(empresa)) {
                cerrarAlert()

                $('#divMensajeError').show()
                $('#lblMensajeError').html('La empresa no puede ser borrada por que tiene uno o más franquicias asignadas.')
                setTimeout(function() {
                    $('#divMensajeError').hide()
                }, 3000);
                return
            }

            cerrarAlert()
            var datosFom = new FormData()
            datosFom.append('intEmpresa', $('#intEmpresaBorrar').val())
            EnviarFormulario(datosFom, 'borrar')
        });

        /* FIN BOTONES*/

        /* INICIA FUNCIONES GENERALES*/
        function validaForm() {
            if ($('#txtNombre').val() != '' &&
                $('#txtRazon').val() != '' &&
                $('#txtRFC').val() != '' &&
                $('#txtDireccion').val() != '' &&
                $('#txtNumExterior').val() != '' &&
                $('#txtCP').val() != '' &&
                $('#selCiudad').val() != '' &&
                $('#selRegimen').val() != '') {
                return true;
            } else {
                return false;
            }
        }

        function RecolectarDatosFormulario(accion) {
            var datosFom = new FormData()
            let imgLogo = $('#imgLogo').prop('files')[0]
            let bitLogo = true

            if (typeof(imgLogo) === 'undefined') {
                bitLogo = false
            }

            if ($('#chActivo').prop("checked")) {
                activo = 1
            } else {
                activo = 0
            }
            datosFom.append('intEmpresa', $('#intEmpresa').val())
            datosFom.append('varNombreComercial', $('#txtNombre').val())
            datosFom.append('varRazonSocial', $('#txtRazon').val())
            datosFom.append('varRFC', $('#txtRFC').val())
            datosFom.append('varDireccion', $('#txtDireccion').val())
            datosFom.append('varTelefono', $('#txtTelefono').val())
            datosFom.append('varEmail', $('#txtEmail').val())
            datosFom.append('bitActivo', activo)
            datosFom.append('varNumeroInterior', $('#txtNumInterior').val())
            datosFom.append('varNumeroExterior', $('#txtNumExterior').val())
            datosFom.append('intCodigoPostal', $('#txtCP').val())
            datosFom.append('intCiudad', $('#selCiudad').val())
            datosFom.append('intRegimenFiscal', $('#selRegimen').val())
            datosFom.append('imgImagen', imgLogo)
            datosFom.append('bitImagen', bitLogo)
            datosFom.append('lblLogo', $('#hlblLogo').val())
            if (accion == 'recuperar') {
                RecuperarEmpresa(datosFom, accion)
            } else {
                EnviarFormulario(datosFom, accion)
            }
        }

        function EnviarFormulario(formulario, accion) {
            $.ajax({
                type: "POST",
                url: "Modulos/Empresas/ProEmpresas.php?accion=" + accion,
                data: formulario,
                contentType: false,
                async: false,
                processData: false,
                cache: false,
                success: function(data) {
                    $("#selCiudad").prop("disabled", false);
                    $('#progressbar').removeClass('w-25');
                    $('#progressbar').addClass('w-100');
                    $("#ModalEditar").modal('hide');
                    LimpiarFormulario()

                    setTimeout(function() {
                        $('#progressbar').hide();
                    }, 3000);
                    MostrarEmpresas();
                    if (!data) {
                        TextoMensajes(accion, 0)
                    } else {
                        TextoMensajes(accion, 1)
                    }
                },
                error: function(error) {
                    $("#selCiudad").prop("disabled", false);
                    $('#progressbar').removeClass('w-25');
                    $('#progressbar').addClass('w-100');
                    setTimeout(function() {
                        $('#progressbar').hide();
                    }, 3000);

                    $("#ModalEditar").modal('hide');
                    TextoMensajes(accion, 0)
                }
            });
        }

        function RecuperarEmpresa(formulario, accion) {
            $.ajax({
                type: 'POST',
                url: 'Modulos/Empresas/ProEmpresas.php?accion=' + accion,
                data: formulario,
                contentType: false,
                async: false,
                processData: false,
                cache: false,
                success: function(datos) {
                    $("#selCiudad").prop("disabled", false);
                    $('#progressbar').removeClass('w-25');
                    $('#progressbar').addClass('w-100');
                    setTimeout(function() {
                        $('#progressbar').hide();
                    }, 3000);

                    $('#intEmpresa').val(datos[0]['intEmpresa']);
                    $('#txtNombre').val(datos[0]['varNombreComercial']);
                    $('#txtRazon').val(datos[0]['varRazonSocial']);
                    $('#txtRFC').val(datos[0]['varRFC']);
                    $('#txtDireccion').val(datos[0]['varDireccion']);
                    $('#txtTelefono').val(datos[0]['varTelefono']);
                    $('#txtEmail').val(datos[0]['varEmail']);
                    if (datos[0]['bitActivo'] == 0) {
                        $("#chActivo").prop("checked", false);
                    } else {
                        $("#chActivo").prop("checked", true);
                    }
                    $('#chActivo').val(datos[0]['bitActivo']);
                    $('#txtNumExterior').val(datos[0]['varNumeroExterior']);
                    $('#txtNumInterior').val(datos[0]['varNumeroInterior']);
                    $('#txtCP').val(datos[0]['intCodigoPostal']);

                    if (datos[0]['varLogo'] != null) {
                        $('#iconFile').addClass('fileinput-exists')
                        $('#iconFile').removeClass('fileinput-new')
                        $('#lblLogo').html(datos[0]['varLogo'])
                        $('#hlblLogo').val(datos[0]['varLogo'])
                    } else {
                        $('#iconFile').removeClass('fileinput-exists')
                        $('#iconFile').addClass('fileinput-new')
                        $('#lblLogo').html('')
                        $('#imgLogo').val('')
                        $('#hlblLogo').val('')
                    }

                    selectItemByValue(document.getElementById('selEstado'), datos[0]['intEstado']);
                    selectItemByValue(document.getElementById('selRegimen'), datos[0]['intRegimenFiscal']);
                    CargarCiudades(datos[0]['intEstado'], datos[0]['intCiudad'])
                },
                error: function() {
                    $('#progressbar').removeClass('w-25');
                    $('#progressbar').addClass('w-100');
                    $("#ModalEditar").modal('hide');
                    $('#divMensajeError').show()
                    $('#lblMensajeError').html('No se pueden recuperar los datos')
                    setTimeout(function() {
                        $('#progressbar').hide();
                        $('#divMensajeError').hide()
                    }, 3000);
                    //alert("Hay un error ..");
                }
            });
        }

        function TextoMensajes(accion, tipo) {
            switch (accion) {
                case 'agregar':
                    if (tipo == 1) {
                        $('#divMensajeExito').show()
                        $('#lblMensajeExito').html('Empresa Guardar con Éxito')

                        setTimeout(function() {
                            $('#divMensajeExito').hide()
                        }, 3000);
                    } else {
                        $('#divMensajeError').show()
                        $('#lblMensajeError').html('Error al Guardar la Empresa')
                        setTimeout(function() {
                            $('#divMensajeError').hide()
                        }, 3000);
                    }
                    break;
                case 'modificar':
                    if (tipo == 1) {
                        $('#divMensajeExito').show()
                        $('#lblMensajeExito').html('Empresa Actualizada con Éxito')

                        setTimeout(function() {
                            $('#divMensajeExito').hide()
                        }, 3000);
                    } else {
                        $('#divMensajeError').show()
                        $('#lblMensajeError').html('Error al Actualizar la Empresa')
                        setTimeout(function() {
                            $('#divMensajeError').hide()
                        }, 3000);
                    }
                    break;
                case 'borrar':
                    if (tipo == 1) {
                        $('#divMensajeExito').show()
                        $('#lblMensajeExito').html('La Empresa se a borrado con Éxito')

                        setTimeout(function() {
                            $('#divMensajeExito').hide()
                        }, 3000);
                    } else {
                        $('#divMensajeError').show()
                        $('#lblMensajeError').html('Error al Borrar la Empresa')
                        setTimeout(function() {
                            $('#divMensajeError').hide()
                        }, 3000);
                    }
                    break;
            }
        }

        function LimpiarFormulario() {

            $('#intEmpresa').val('')
            $('#txtNombre').val('')
            $('#txtRazon').val('')
            $('#txtRFC').val('')
            $('#txtDireccion').val('')
            $('#txtTelefono').val('')
            $('#txtEmail').val('')
            $("#chActivo").prop("checked", true);
            $('#txtNumExterior').val('')
            $('#txtNumInterior').val('')
            $('#txtCP').val('')

            let filas = '<option value="">Seleccionar</option>';
            $('#selCiudad').html(filas);
            CargarEstados();
            CargarRegimenFiscal()
            $("#selCiudad").prop("disabled", true);
            $('#lblLogo').html('')
            $('#iconFile').removeClass('fileinput-exists')
            $('#iconFile').addClass('fileinput-new')
            $('#imgLogo').val('')
        }

        $('#selEstado').on('change', function() {
            if ($(this).val() != '') {
                CargarCiudades($(this).val(), 0)
            } else {
                let filas = '<option value="">Seleccionar</option>';
                $('#selCiudad').html(filas);
            }
        });

        function selectItemByValue(elmnt, value) {
            for (var i = 0; i < elmnt.options.length; i++) {
                if (elmnt.options[i].value == value)
                    elmnt.selectedIndex = i;
            }
        }

        function validarBorrar(empresa) {
            var resultado = false;
            $.ajax({
                async: false,
                type: 'POST',
                url: 'Modulos/Empresas/ProEmpresas.php?accion=validaBorrarEmpresa',
                data: empresa,

                success: function(datos) {
                    if (datos[0]['Franquicias'] > 0) {
                        resultado = false;
                    } else {
                        resultado = true;
                    }

                },
            });
            return resultado;
        }

        function cerrarAlert() {
            $("#alertBorrar").removeClass('show')
        }

        /* FIN FUNCIONES GENERALES*/
    });
</script>
<!-- /Container -->